# 如何确保消息发送和消费

## 持久化

"持久化"这个词汇在前面的篇幅中有多次提及，持久化可以提高 RabbitMQ 的可靠性， 以防在异常情况(重启、关闭、右机等)下的数据丢失 。本节针对这个概念做一个总结。 RabbitMQ的持久化分为三个部分:交换器的持久化、队列的持久化和消息的持久化 。


* 交换机持久化

	交换器的持久化是通过在声明队列是将 durable 参数置为 true 实现的，如果交换器不设置持久化，那么在 RabbitMQ 服务重启之后，相关的交换器元数据会丢失，**不过消息不会丢失**，只是不能将消息发送到这个交换器中了。对一个长期使用的交换器来说，建议将其置为持久化的。

* 队列持久化

	队列的持久化是通过在声明队列时将 durable 参数置为 true 实现的，如果队列不设置持久化，那么在 RabbitMQ 服务重启之后，相关队列的元数据会丢失，此时数据也会丢失。正所谓"皮之不存，毛将焉附"，队列都没有了，消息又能存在哪里呢?

* 消息持久化

	队列的持久化能保证其本身的元数据不会因异常情况而丢失，但是并不能保证内部所存储的消息不会丢失。要确保消息不会丢失 ， 需要将其设置为持久化。通过将消息的投递模式(BasicPropert i es 中的 deliveryMode 属性)设置为 2 即可实现消息的持久化。